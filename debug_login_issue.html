<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Login Issue</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .debug-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .success { background: #28a745; }
        .danger { background: #dc3545; }
        .warning { background: #ffc107; color: #212529; }
        .info { background: #17a2b8; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug "No Property Assigned" Issue</h1>
        
        <div class="debug-section">
            <h3>Step 1: Check Current Browser Storage</h3>
            <button onclick="checkStorage()">Check localStorage & sessionStorage</button>
            <div id="storage-info"></div>
        </div>

        <div class="debug-section">
            <h3>Step 2: Test Backend API Directly</h3>
            <button onclick="testAuthMe()" class="info">Test /auth/me Endpoint</button>
            <div id="api-test-result"></div>
        </div>

        <div class="debug-section">
            <h3>Step 3: Clear Cache & Force Fresh Login</h3>
            <button onclick="clearAndReload()" class="warning">Clear All Auth Data</button>
            <button onclick="forceRefreshUser()" class="success">Force Refresh User Data</button>
            <div id="refresh-result"></div>
        </div>

        <div class="debug-section">
            <h3>Step 4: Manual Login Test</h3>
            <div style="margin: 10px 0;">
                <input type="email" id="email" placeholder="Email" value="gvemula@mail.yu.edu" style="padding: 8px; margin: 5px; width: 200px;">
                <input type="password" id="password" placeholder="Password" style="padding: 8px; margin: 5px; width: 200px;">
                <button onclick="testLogin()" class="info">Test Login</button>
            </div>
            <div id="login-test-result"></div>
        </div>

        <div class="debug-section">
            <h3>Debug Information</h3>
            <div id="debug-log"></div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.hostname === 'localhost' ? 'http://localhost:8000/api' : 'https://clickwise.in/api';
        
        function log(message, type = 'info') {
            const debugLog = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#007bff';
            debugLog.innerHTML += `<div style="color: ${color}; margin: 5px 0;">[${timestamp}] ${message}</div>`;
        }

        function checkStorage() {
            const container = document.getElementById('storage-info');
            container.innerHTML = '<h4>Browser Storage Contents:</h4>';
            
            // Check localStorage
            const localStorageDiv = document.createElement('div');
            localStorageDiv.innerHTML = '<h5>localStorage:</h5>';
            
            const authKeys = ['token', 'user', 'token_expires_at', 'returnUrl'];
            authKeys.forEach(key => {
                const value = localStorage.getItem(key);
                const div = document.createElement('div');
                div.className = 'code-block';
                
                if (value) {
                    if (key === 'user') {
                        try {
                            const userData = JSON.parse(value);
                            div.innerHTML = `<strong>${key}:</strong>\n${JSON.stringify(userData, null, 2)}`;
                            
                            // Highlight the property_id
                            if (userData.property_id) {
                                log(`‚úÖ User has property_id: ${userData.property_id}`, 'success');
                            } else {
                                log(`‚ùå User property_id is: ${userData.property_id}`, 'error');
                            }
                        } catch (e) {
                            div.innerHTML = `<strong>${key}:</strong> ${value} (Invalid JSON)`;
                            log(`‚ùå Invalid user JSON in localStorage`, 'error');
                        }
                    } else if (key === 'token') {
                        div.innerHTML = `<strong>${key}:</strong> ${value.substring(0, 50)}... (${value.length} chars)`;
                    } else {
                        div.innerHTML = `<strong>${key}:</strong> ${value}`;
                    }
                } else {
                    div.innerHTML = `<strong>${key}:</strong> <em>Not set</em>`;
                    div.style.background = '#fff3cd';
                    div.style.color = '#856404';
                }
                
                localStorageDiv.appendChild(div);
            });
            
            container.appendChild(localStorageDiv);
            log('Storage check completed');
        }

        async function testAuthMe() {
            const resultDiv = document.getElementById('api-test-result');
            resultDiv.innerHTML = '<p>üîÑ Testing /auth/me endpoint...</p>';
            
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    resultDiv.innerHTML = '<p style="color: red;">‚ùå No token found in localStorage</p>';
                    log('No token found for /auth/me test', 'error');
                    return;
                }
                
                log('Testing /auth/me with token: ' + token.substring(0, 20) + '...');
                
                const response = await fetch(`${API_BASE}/auth/me`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    const userData = result.data;
                    resultDiv.innerHTML = `
                        <div style="background: #d4edda; padding: 15px; border-radius: 5px;">
                            <h4>‚úÖ /auth/me Success!</h4>
                            <div class="code-block">${JSON.stringify(userData, null, 2)}</div>
                            <p><strong>Property ID:</strong> ${userData.property_id || 'NULL'}</p>
                        </div>
                    `;
                    
                    if (userData.property_id) {
                        log(`‚úÖ Backend returns property_id: ${userData.property_id}`, 'success');
                    } else {
                        log(`‚ùå Backend returns NULL property_id`, 'error');
                    }
                } else {
                    resultDiv.innerHTML = `
                        <div style="background: #f8d7da; padding: 15px; border-radius: 5px;">
                            <h4>‚ùå /auth/me Failed</h4>
                            <div class="code-block">${JSON.stringify(result, null, 2)}</div>
                        </div>
                    `;
                    log(`‚ùå /auth/me failed: ${result.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `<p style="color: red;">‚ùå Network error: ${error.message}</p>`;
                log(`‚ùå Network error in /auth/me: ${error.message}`, 'error');
            }
        }

        async function forceRefreshUser() {
            const resultDiv = document.getElementById('refresh-result');
            resultDiv.innerHTML = '<p>üîÑ Force refreshing user data...</p>';
            
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    resultDiv.innerHTML = '<p style="color: red;">‚ùå No token found</p>';
                    return;
                }
                
                const response = await fetch(`${API_BASE}/auth/me`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const freshUserData = result.data;
                    
                    // Update localStorage
                    localStorage.setItem('user', JSON.stringify(freshUserData));
                    
                    resultDiv.innerHTML = `
                        <div style="background: #d4edda; padding: 15px; border-radius: 5px;">
                            <h4>‚úÖ User data refreshed!</h4>
                            <p>Property ID: ${freshUserData.property_id || 'NULL'}</p>
                            <button onclick="window.location.reload()" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 3px; cursor: pointer;">Reload Page</button>
                        </div>
                    `;
                    
                    log(`‚úÖ User data refreshed with property_id: ${freshUserData.property_id}`, 'success');
                } else {
                    const errorData = await response.json();
                    resultDiv.innerHTML = `<p style="color: red;">‚ùå Failed: ${errorData.message}</p>`;
                    log(`‚ùå Refresh failed: ${errorData.message}`, 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `<p style="color: red;">‚ùå Error: ${error.message}</p>`;
                log(`‚ùå Refresh error: ${error.message}`, 'error');
            }
        }

        function clearAndReload() {
            log('Clearing all auth data...');
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            localStorage.removeItem('token_expires_at');
            localStorage.removeItem('returnUrl');
            sessionStorage.clear();
            
            log('‚úÖ Auth data cleared, reloading page...', 'success');
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }

        async function testLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const resultDiv = document.getElementById('login-test-result');
            
            if (!email || !password) {
                resultDiv.innerHTML = '<p style="color: red;">Please enter email and password</p>';
                return;
            }
            
            resultDiv.innerHTML = '<p>üîÑ Testing login...</p>';
            log(`Testing login for: ${email}`);
            
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    const { token, user, expires_at } = result.data;
                    
                    resultDiv.innerHTML = `
                        <div style="background: #d4edda; padding: 15px; border-radius: 5px;">
                            <h4>‚úÖ Login Success!</h4>
                            <div class="code-block">${JSON.stringify(user, null, 2)}</div>
                            <p><strong>Property ID:</strong> ${user.property_id || 'NULL'}</p>
                            <button onclick="saveLoginData('${token}', '${JSON.stringify(user).replace(/'/g, "\\'")}', '${expires_at}')" 
                                    style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 3px; cursor: pointer;">
                                Save & Reload
                            </button>
                        </div>
                    `;
                    
                    log(`‚úÖ Login successful with property_id: ${user.property_id}`, 'success');
                } else {
                    resultDiv.innerHTML = `
                        <div style="background: #f8d7da; padding: 15px; border-radius: 5px;">
                            <h4>‚ùå Login Failed</h4>
                            <div class="code-block">${JSON.stringify(result, null, 2)}</div>
                        </div>
                    `;
                    log(`‚ùå Login failed: ${result.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `<p style="color: red;">‚ùå Network error: ${error.message}</p>`;
                log(`‚ùå Login network error: ${error.message}`, 'error');
            }
        }

        function saveLoginData(token, userJson, expiresAt) {
            try {
                const user = JSON.parse(userJson);
                localStorage.setItem('token', token);
                localStorage.setItem('user', JSON.stringify(user));
                localStorage.setItem('token_expires_at', expiresAt);
                
                log('‚úÖ Login data saved to localStorage', 'success');
                window.location.reload();
            } catch (error) {
                log(`‚ùå Error saving login data: ${error.message}`, 'error');
            }
        }

        // Auto-check storage on page load
        window.onload = function() {
            checkStorage();
            log('Debug page loaded');
        };
    </script>
</body>
</html>
