import{j as e}from"./radixUI-MBKqlelr.js";import{a as o}from"./vendor-BQUE8CnD.js";import{C as ne,b as le,c as oe,a as ce}from"./card-0UsC1Hfx.js";import{B as C,L as de,T as J,A as K,b as X,u as Pe,a as Se,c as I}from"./index-BX3Jf5rY.js";import{I as D}from"./input-C7n7UaRv.js";import{D as me,a as Ae,b as pe,c as he,d as ge,e as xe}from"./dialog-BrcI6BMt.js";import{S as De,T as ke,a as _e,b as ee,c as E,d as Ee,e as A}from"./table-B6NKxQYn.js";import{L as F}from"./label-BGHhm9HA.js";import{Q as Fe}from"./qr-code-display-13m4lBF-.js";import{A as Le,a as Te,b as $e,c as ze,d as Me,e as Ue,f as Ie,g as Be,S as qe}from"./alert-dialog-CpHvPefG.js";import{B as Oe}from"./badge-DbL2e8Dt.js";import{a as Re}from"./utils-Co3JUx4V.js";import{C as He}from"./circle-check-big-D7qwqCjm.js";import{U as je}from"./users-DJfJLhR6.js";import{F as Ze}from"./file-text-lgpzM1Mh.js";import{U as Qe}from"./user-check-kaC5-dJg.js";import{B as Ve}from"./building-D7pk8e3U.js";import{P as We}from"./plus-_zwNWoy_.js";import{M as Ye}from"./map-pin-DbAZafho.js";import{P as Ge}from"./phone-CsbprQIk.js";import{T as Je}from"./trash-2-CRAWfZhR.js";import{A as Ke,a as Xe,b as es}from"./arrow-up-0Yxd4vbS.js";import"./copy-Bygxza59.js";import"./refresh-cw-FCIZnuDU.js";import"./download-DxzIzwbA.js";const ue=({formData:r,setFormData:j,onSubmit:N,title:k,submitting:w,onCancel:L})=>{const[f,T]=o.useState([]),$=t=>{const p=t.replace(/\D/g,"").slice(0,10);return p.length>=6?`(${p.slice(0,3)}) ${p.slice(3,6)}-${p.slice(6)}`:p.length>=3?`(${p.slice(0,3)}) ${p.slice(3)}`:p},v=()=>{const t=[];return r.name.trim()||t.push("Property name is required"),r.address.trim()||t.push("Street address is required"),r.city.trim()||t.push("City is required"),r.state.trim()||t.push("State is required"),r.zip_code.trim()||t.push("ZIP code is required"),r.state&&!/^[A-Za-z]{2}$/.test(r.state)&&t.push("State must be 2 letters (e.g., CA, NY)"),r.zip_code&&!/^\d{5}(-\d{4})?$/.test(r.zip_code)&&t.push("ZIP code must be in format 12345 or 12345-6789"),r.phone&&r.phone.trim()&&r.phone.replace(/\D/g,"").length!==10&&t.push("Phone must be 10 digits"),t},i=t=>{t.preventDefault();const y=v();if(y.length>0){T(y);return}T([]),N(t)};return e.jsxs("form",{onSubmit:i,className:"space-y-4",children:[f.length>0&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-md p-3",children:e.jsxs("div",{className:"text-sm text-red-800",children:[e.jsx("p",{className:"font-medium mb-1",children:"Please fix the following errors:"}),e.jsx("ul",{className:"list-disc list-inside space-y-1",children:f.map((t,y)=>e.jsx("li",{children:t},y))})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(F,{htmlFor:"name",children:"Property Name *"}),e.jsx(D,{id:"name",value:r.name,onChange:t=>j({...r,name:t.target.value}),placeholder:"Grand Plaza Hotel",className:f.some(t=>t.includes("Property name"))?"border-red-300":""})]}),e.jsxs("div",{children:[e.jsx(F,{htmlFor:"phone",children:"Phone"}),e.jsx(D,{id:"phone",value:r.phone,onChange:t=>j({...r,phone:$(t.target.value)}),placeholder:"(555) 123-4567",maxLength:14,className:f.some(t=>t.includes("Phone"))?"border-red-300":""})]})]}),e.jsxs("div",{children:[e.jsx(F,{htmlFor:"address",children:"Street Address *"}),e.jsx(D,{id:"address",value:r.address,onChange:t=>j({...r,address:t.target.value}),placeholder:"123 Main Street",className:f.some(t=>t.includes("Street address"))?"border-red-300":""})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx(F,{htmlFor:"city",children:"City *"}),e.jsx(D,{id:"city",value:r.city,onChange:t=>j({...r,city:t.target.value}),placeholder:"Miami Beach",className:f.some(t=>t.includes("City"))?"border-red-300":""})]}),e.jsxs("div",{children:[e.jsx(F,{htmlFor:"state",children:"State *"}),e.jsx(D,{id:"state",value:r.state,onChange:t=>j({...r,state:t.target.value.toUpperCase()}),placeholder:"FL",maxLength:2,className:f.some(t=>t.includes("State"))?"border-red-300":""})]}),e.jsxs("div",{children:[e.jsx(F,{htmlFor:"zip_code",children:"ZIP Code *"}),e.jsx(D,{id:"zip_code",value:r.zip_code,onChange:t=>j({...r,zip_code:t.target.value}),placeholder:"33139",className:f.some(t=>t.includes("ZIP code"))?"border-red-300":""})]})]}),e.jsxs("div",{className:"flex justify-end space-x-2 pt-4",children:[e.jsx(C,{type:"button",variant:"outline",onClick:L,children:"Cancel"}),e.jsx(C,{type:"submit",disabled:w,children:w?"Saving...":k})]})]})};function ss({open:r,onOpenChange:j,propertyId:N,propertyName:k,onDelete:w,onSuccess:L}){const[f,T]=o.useState(!1),[$,v]=o.useState(!1),[i,t]=o.useState(null),[y,p]=o.useState(null),[_,B]=o.useState(!1);o.useEffect(()=>{r&&N&&z()},[r,N]);const z=async()=>{var x,M;v(!0),p(null);try{const P=localStorage.getItem("token"),n=await Re.get(`/api/hr/properties/${N}/can-delete`,{headers:{Authorization:`Bearer ${P}`}});t(n.data)}catch(P){console.error("Failed to check deletion:",P),p(((M=(x=P.response)==null?void 0:x.data)==null?void 0:M.detail)||"Failed to check if property can be deleted")}finally{v(!1)}},Z=async()=>{B(!0),p(null);try{await w(),L(),j(!1)}catch{}finally{B(!1)}};return e.jsx(Le,{open:r,onOpenChange:j,children:e.jsxs(Te,{className:"max-w-2xl",children:[e.jsxs($e,{children:[e.jsxs(ze,{children:["Delete Property: ",k]}),e.jsx(Me,{asChild:!0,children:e.jsx("div",{className:"space-y-4",children:$?e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx(de,{className:"w-6 h-6 animate-spin mr-2"}),e.jsx("span",{children:"Checking property dependencies..."})]}):i?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:`flex items-center gap-2 p-3 rounded-lg ${i.canDelete?"bg-green-50 text-green-700 border border-green-200":"bg-red-50 text-red-700 border border-red-200"}`,children:i.canDelete?e.jsxs(e.Fragment,{children:[e.jsx(He,{className:"w-5 h-5"}),e.jsx("span",{className:"font-medium",children:"This property can be safely deleted"})]}):e.jsxs(e.Fragment,{children:[e.jsx(J,{className:"w-5 h-5"}),e.jsx("span",{className:"font-medium",children:i.message})]})}),e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg space-y-3",children:[e.jsx("h4",{className:"font-medium text-sm text-gray-700",children:"Property Status"}),i.blockers.managers.length>0&&e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(je,{className:"w-4 h-4 text-blue-500 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"text-sm font-medium",children:[i.blockers.managers.length," Manager(s) Assigned"]}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:i.blockers.managers.map(x=>x.name||x.email).join(", ")}),i.suggestions.autoUnassign&&e.jsx(Oe,{variant:"secondary",className:"mt-1 text-xs",children:"Will be automatically unassigned"})]})]}),i.blockers.pendingApplications>0&&e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(Ze,{className:"w-4 h-4 text-orange-500 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"text-sm font-medium text-red-600",children:[i.blockers.pendingApplications," Pending Application(s)"]}),e.jsx("div",{className:"text-xs text-gray-600",children:"Must be processed before deletion"})]})]}),i.blockers.activeEmployees>0&&e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(Qe,{className:"w-4 h-4 text-red-500 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"text-sm font-medium text-red-600",children:[i.blockers.activeEmployees," Active Employee(s)"]}),e.jsx("div",{className:"text-xs text-gray-600",children:"Must be reassigned or made inactive"})]})]}),i.blockers.managers.length===0&&i.blockers.pendingApplications===0&&i.blockers.activeEmployees===0&&e.jsx("div",{className:"text-sm text-gray-600",children:"No active dependencies found"})]}),!i.canDelete&&i.suggestions.reassignToProperties.length>0&&e.jsxs(K,{children:[e.jsx(Ve,{className:"w-4 h-4"}),e.jsxs(X,{children:[e.jsx("strong",{children:"Suggestion:"})," Reassign employees and managers to:",e.jsx("div",{className:"mt-2 space-y-1",children:i.suggestions.reassignToProperties.map(x=>e.jsxs("div",{className:"text-sm",children:["â€¢ ",x.name]},x.id))})]})]}),i.canDelete&&e.jsxs(K,{variant:"destructive",children:[e.jsx(J,{className:"w-4 h-4"}),e.jsxs(X,{children:[e.jsx("strong",{children:"Warning:"})," This action will permanently delete the property",i.blockers.managers.length>0&&` and unassign ${i.blockers.managers.length} manager(s)`,". This cannot be undone."]})]})]}):y?e.jsxs(K,{variant:"destructive",children:[e.jsx(J,{className:"w-4 h-4"}),e.jsx(X,{children:y})]}):null})})]}),e.jsxs(Ue,{children:[e.jsx(Ie,{disabled:_,children:"Cancel"}),(i==null?void 0:i.canDelete)&&e.jsx(Be,{onClick:Z,disabled:_,className:"bg-red-600 hover:bg-red-700",children:_?e.jsxs(e.Fragment,{children:[e.jsx(de,{className:"w-4 h-4 mr-2 animate-spin"}),"Deleting..."]}):e.jsxs(e.Fragment,{children:["Delete Property",i.blockers.managers.length>0&&` & Unassign ${i.blockers.managers.length} Manager(s)`]})})]})]})})}function ks({onStatsUpdate:r=()=>{}}){const{user:j,loading:N}=Pe(),[k,w]=o.useState([]),[L,f]=o.useState([]),[T,$]=o.useState(!0),[v,i]=o.useState(""),[t,y]=o.useState("name"),[p,_]=o.useState("asc"),[B,z]=o.useState(!1),[Z,x]=o.useState(!1),[M,P]=o.useState(null),[n,q]=o.useState({name:"",address:"",city:"",state:"",zip_code:"",phone:""}),[se,O]=o.useState(!1),[ts,as]=o.useState(null),[fe,te]=o.useState(!1),[R,ae]=o.useState(null),{toast:S}=Se();o.useEffect(()=>{!N&&j&&(b(),ye())},[N,j]);const b=async()=>{var s,c,l,d;try{console.log("Fetching properties...");const h=await I.hr.getProperties(),a=Array.isArray(h.data)?h.data:[];console.log(`Fetched ${a.length} properties`),w(a),r()}catch(h){console.error("Error fetching properties:",h);let a="Failed to fetch properties";((s=h.response)==null?void 0:s.status)===401?a="Session expired. Please log in again.":((c=h.response)==null?void 0:c.status)===403?a="You don't have permission to view properties.":(d=(l=h.response)==null?void 0:l.data)!=null&&d.detail&&(a=h.response.data.detail),S({title:"Error",description:a,variant:"destructive"}),w([])}finally{$(!1)}},ye=async()=>{try{const s=await I.hr.getManagers(),c=Array.isArray(s.data)?s.data:[];f(c)}catch(s){console.error("Error fetching managers:",s)}},ve=async s=>{var c,l,d,h;s.preventDefault(),O(!0);try{if(!n.name||!n.address||!n.city||!n.state||!n.zip_code)throw new Error("Please fill in all required fields");const a={name:n.name.trim(),address:n.address.trim(),city:n.city.trim(),state:n.state.trim().toUpperCase(),zip_code:n.zip_code.trim(),phone:n.phone.trim()||""};console.log("Creating property with data:",a);const g=await I.hr.createProperty(a);S({title:"Success",description:`Property "${a.name}" created successfully`}),z(!1),Q(),await b()}catch(a){console.error("Error creating property:",a);let g="Failed to create property";a.message?g=a.message:(l=(c=a.response)==null?void 0:c.data)!=null&&l.detail?Array.isArray(a.response.data.detail)?g=a.response.data.detail.map(m=>{var U;return`${(((U=m.loc)==null?void 0:U[m.loc.length-1])||"field").replace(/_/g," ").replace(/\b\w/g,G=>G.toUpperCase())}: ${m.msg}`}).join(", "):typeof a.response.data.detail=="string"&&(g=a.response.data.detail):((d=a.response)==null?void 0:d.status)===500?g="Server error. Please check if all fields are correctly filled and try again.":((h=a.response)==null?void 0:h.status)===400&&(g="Invalid data. Please check your input and try again."),S({title:"Error Creating Property",description:g,variant:"destructive"})}finally{O(!1)}},Ne=async s=>{var c,l,d,h;if(s.preventDefault(),!!M){O(!0);try{if(!n.name||!n.address||!n.city||!n.state||!n.zip_code)throw new Error("Please fill in all required fields");const a={name:n.name.trim(),address:n.address.trim(),city:n.city.trim(),state:n.state.trim().toUpperCase(),zip_code:n.zip_code.trim(),phone:n.phone.trim()||""};console.log("Updating property with data:",a),await I.hr.updateProperty(M.id,a),S({title:"Success",description:`Property "${a.name}" updated successfully`}),x(!1),P(null),Q(),await b()}catch(a){console.error("Error updating property:",a);let g="Failed to update property";a.message?g=a.message:(l=(c=a.response)==null?void 0:c.data)!=null&&l.detail?Array.isArray(a.response.data.detail)?g=a.response.data.detail.map(m=>{var U;return`${(((U=m.loc)==null?void 0:U[m.loc.length-1])||"field").replace(/_/g," ").replace(/\b\w/g,G=>G.toUpperCase())}: ${m.msg}`}).join(", "):typeof a.response.data.detail=="string"&&(g=a.response.data.detail):((d=a.response)==null?void 0:d.status)===500?g="Server error. Please check if all fields are correctly filled and try again.":((h=a.response)==null?void 0:h.status)===404&&(g="Property not found. It may have been deleted.",await b()),S({title:"Error Updating Property",description:g,variant:"destructive"})}finally{O(!1)}}},be=async s=>{var d,h,a,g,H;const c=k.find(m=>m.id===s),l=(c==null?void 0:c.name)||"property";try{console.log("Deleting property:",s);const u=((d=(await I.hr.deleteProperty(s)).data)==null?void 0:d.detail)||`Property "${l}" deleted successfully`;S({title:"Success",description:u}),await b()}catch(m){console.error("Error deleting property:",m);let u="Failed to delete property";(a=(h=m.response)==null?void 0:h.data)!=null&&a.detail?Array.isArray(m.response.data.detail)?u=m.response.data.detail.map(Y=>Y.msg).join(", "):typeof m.response.data.detail=="string"&&(u=m.response.data.detail,u.includes("active applications or employees")?u=`Cannot delete "${l}" because it has active applications or employees. Please ensure all applications are processed and employees are reassigned or made inactive before deleting.`:u.includes("has managers assigned")&&(u=`Cannot delete "${l}" because it has managers assigned. Please unassign all managers first.`)):((g=m.response)==null?void 0:g.status)===404?(u="Property not found. It may have already been deleted.",await b()):((H=m.response)==null?void 0:H.status)===500&&(u="Server error occurred while deleting the property. Please try again."),S({title:"Cannot Delete Property",description:u,variant:"destructive"})}},Q=()=>{q({name:"",address:"",city:"",state:"",zip_code:"",phone:""})},Ce=s=>{P(s),q({name:s.name,address:s.address,city:s.city,state:s.state,zip_code:s.zip_code,phone:s.phone||""}),x(!0)},V=s=>{t===s?_(p==="asc"?"desc":"asc"):(y(s),_("asc"))},W=s=>t!==s?e.jsx(Ke,{className:"w-4 h-4 ml-1 text-gray-400"}):p==="asc"?e.jsx(Xe,{className:"w-4 h-4 ml-1 text-blue-600"}):e.jsx(es,{className:"w-4 h-4 ml-1 text-blue-600"}),we=s=>s.map(c=>{const l=L.find(d=>d.id===c);return l?l.first_name&&l.last_name?`${l.first_name} ${l.last_name}`:l.email:"Unknown Manager"}).join(", "),re=k.filter(s=>s.name.toLowerCase().includes(v.toLowerCase())||s.city.toLowerCase().includes(v.toLowerCase())||s.state.toLowerCase().includes(v.toLowerCase())).sort((s,c)=>{let l,d;switch(t){case"name":l=s.name.toLowerCase(),d=c.name.toLowerCase();break;case"city":l=s.city.toLowerCase(),d=c.city.toLowerCase();break;case"state":l=s.state.toLowerCase(),d=c.state.toLowerCase();break;case"created_at":l=new Date(s.created_at),d=new Date(c.created_at);break;default:return 0}return l<d?p==="asc"?-1:1:l>d?p==="asc"?1:-1:0}),ie=()=>{z(!1),x(!1),Q()};return T?e.jsxs(ne,{children:[e.jsx(le,{children:e.jsx(oe,{children:"Properties Management"})}),e.jsx(ce,{children:e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"text-gray-500",children:"Loading properties..."})})})]}):e.jsxs(ne,{children:[e.jsx(le,{children:e.jsxs(oe,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Properties Management"}),e.jsxs(me,{open:B,onOpenChange:z,children:[e.jsx(Ae,{asChild:!0,children:e.jsxs(C,{children:[e.jsx(We,{className:"w-4 h-4 mr-2"}),"Add Property"]})}),e.jsxs(pe,{className:"max-w-2xl",children:[e.jsxs(he,{children:[e.jsx(ge,{children:"Create New Property"}),e.jsx(xe,{children:"Add a new property to the system. A QR code will be generated for job applications."})]}),e.jsx(ue,{formData:n,setFormData:q,onSubmit:ve,title:"Create Property",submitting:se,onCancel:ie})]})]})]})}),e.jsxs(ce,{children:[e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"relative",children:[e.jsx(De,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx(D,{placeholder:"Search properties by name, city, or state...",value:v,onChange:s=>i(s.target.value),className:"pl-10"})]})}),e.jsx("div",{className:"border rounded-lg",children:e.jsxs(ke,{children:[e.jsx(_e,{children:e.jsxs(ee,{children:[e.jsx(E,{children:e.jsxs(C,{variant:"ghost",className:"h-auto p-0 font-semibold hover:bg-transparent",onClick:()=>V("name"),children:["Property Name",W("name")]})}),e.jsx(E,{children:e.jsxs(C,{variant:"ghost",className:"h-auto p-0 font-semibold hover:bg-transparent",onClick:()=>V("city"),children:["Location",W("city")]})}),e.jsx(E,{children:"Contact"}),e.jsx(E,{children:"Managers"}),e.jsx(E,{children:e.jsxs(C,{variant:"ghost",className:"h-auto p-0 font-semibold hover:bg-transparent",onClick:()=>V("created_at"),children:["Created",W("created_at")]})}),e.jsx(E,{children:"Actions"})]})}),e.jsx(Ee,{children:re.length===0?e.jsx(ee,{children:e.jsx(A,{colSpan:7,className:"text-center py-8 text-gray-500",children:v?"No properties found matching your search.":"No properties found. Create your first property to get started."})}):re.map(s=>e.jsxs(ee,{children:[e.jsxs(A,{children:[e.jsx("div",{className:"font-medium",children:s.name}),e.jsxs("div",{className:"text-sm text-gray-500",children:["ID: ",s.id.slice(0,8),"..."]})]}),e.jsx(A,{children:e.jsxs("div",{className:"flex items-center text-sm",children:[e.jsx(Ye,{className:"w-4 h-4 mr-1 text-gray-400"}),e.jsxs("div",{children:[e.jsx("div",{children:s.address}),e.jsxs("div",{className:"text-gray-500",children:[s.city,", ",s.state," ",s.zip_code]})]})]})}),e.jsx(A,{children:s.phone&&e.jsxs("div",{className:"flex items-center text-sm",children:[e.jsx(Ge,{className:"w-4 h-4 mr-1 text-gray-400"}),s.phone]})}),e.jsx(A,{children:e.jsxs("div",{className:"flex items-center text-sm",children:[e.jsx(je,{className:"w-4 h-4 mr-1 text-gray-400"}),e.jsx("div",{children:s.manager_ids.length>0?e.jsx("div",{className:"text-sm",children:we(s.manager_ids)}):e.jsx("span",{className:"text-gray-500",children:"No managers assigned"})})]})}),e.jsx(A,{children:e.jsx("div",{className:"text-sm text-gray-500",children:new Date(s.created_at).toLocaleDateString()})}),e.jsx(A,{children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(C,{variant:"outline",size:"sm",onClick:()=>Ce(s),title:"Edit Property",children:e.jsx(qe,{className:"w-4 h-4"})}),e.jsx(Fe,{property:s,onRegenerate:b,showRegenerateButton:!0}),e.jsx(C,{variant:"outline",size:"sm",title:"Delete Property",onClick:()=>{ae(s),te(!0)},children:e.jsx(Je,{className:"w-4 h-4 text-red-500"})})]})})]},s.id))})]})}),e.jsx(me,{open:Z,onOpenChange:x,children:e.jsxs(pe,{className:"max-w-2xl",children:[e.jsxs(he,{children:[e.jsx(ge,{children:"Edit Property"}),e.jsx(xe,{children:"Update property information and settings."})]}),e.jsx(ue,{formData:n,setFormData:q,onSubmit:Ne,title:"Update Property",submitting:se,onCancel:ie})]})}),R&&e.jsx(ss,{open:fe,onOpenChange:te,propertyId:R.id,propertyName:R.name,onDelete:async()=>{await be(R.id)},onSuccess:()=>{ae(null),b()}})]})]})}export{ks as default};
