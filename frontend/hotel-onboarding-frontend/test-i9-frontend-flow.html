<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>I-9 Frontend Flow Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      border-bottom: 2px solid #3b82f6;
      padding-bottom: 10px;
    }
    h2 {
      color: #666;
      margin-top: 30px;
    }
    .test-section {
      background: #f8f9fa;
      border-left: 4px solid #3b82f6;
      padding: 15px;
      margin: 20px 0;
    }
    .test-item {
      display: flex;
      align-items: center;
      padding: 10px;
      margin: 5px 0;
      background: white;
      border-radius: 4px;
    }
    .status {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      margin-right: 15px;
      background: #ccc;
    }
    .status.success { background: #10b981; }
    .status.error { background: #ef4444; }
    .status.warning { background: #f59e0b; }
    .status.running { background: #3b82f6; animation: pulse 1s infinite; }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    .test-name {
      flex: 1;
      font-weight: 500;
    }
    .test-result {
      color: #666;
      font-size: 14px;
    }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px;
    }
    button:hover { background: #2563eb; }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .log-output {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 4px;
      font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
      margin-top: 20px;
    }
    .log-entry {
      margin: 2px 0;
      white-space: pre-wrap;
    }
    .log-entry.success { color: #10b981; }
    .log-entry.error { color: #ef4444; }
    .log-entry.warning { color: #f59e0b; }
    .log-entry.info { color: #3b82f6; }
    .summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }
    .summary-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
    }
    .summary-card h3 {
      margin: 0 0 10px 0;
      color: #666;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .summary-card .value {
      font-size: 32px;
      font-weight: bold;
      margin: 10px 0;
    }
    .summary-card.success .value { color: #10b981; }
    .summary-card.error .value { color: #ef4444; }
    .summary-card.warning .value { color: #f59e0b; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß™ I-9 Frontend Flow Test Suite</h1>

    <div class="test-section">
      <h2>Test Controls</h2>
      <button onclick="runAllTests()">Run All Tests</button>
      <button onclick="clearLog()">Clear Log</button>
      <button onclick="resetTests()">Reset</button>
      <button onclick="testFrontendNavigation()">Test Navigation Only</button>
    </div>

    <div class="summary">
      <div class="summary-card success">
        <h3>Passed</h3>
        <div class="value" id="passed-count">0</div>
      </div>
      <div class="summary-card error">
        <h3>Failed</h3>
        <div class="value" id="failed-count">0</div>
      </div>
      <div class="summary-card warning">
        <h3>Warnings</h3>
        <div class="value" id="warning-count">0</div>
      </div>
      <div class="summary-card">
        <h3>Success Rate</h3>
        <div class="value" id="success-rate">0%</div>
      </div>
    </div>

    <div class="test-section">
      <h2>Test Results</h2>

      <div class="test-item" id="test-backend">
        <div class="status" id="status-backend"></div>
        <div class="test-name">Backend Health Check</div>
        <div class="test-result" id="result-backend"></div>
      </div>

      <div class="test-item" id="test-navigation">
        <div class="status" id="status-navigation"></div>
        <div class="test-name">Navigation Through I-9 Steps</div>
        <div class="test-result" id="result-navigation"></div>
      </div>

      <div class="test-item" id="test-form">
        <div class="status" id="status-form"></div>
        <div class="test-name">I-9 Form Data Submission</div>
        <div class="test-result" id="result-form"></div>
      </div>

      <div class="test-item" id="test-supplements">
        <div class="status" id="status-supplements"></div>
        <div class="test-name">Supplements Step Navigation</div>
        <div class="test-result" id="result-supplements"></div>
      </div>

      <div class="test-item" id="test-upload">
        <div class="status" id="status-upload"></div>
        <div class="test-name">Document Upload to Supabase</div>
        <div class="test-result" id="result-upload"></div>
      </div>

      <div class="test-item" id="test-signature">
        <div class="status" id="status-signature"></div>
        <div class="test-name">I-9 Signature & PDF Generation</div>
        <div class="test-result" id="result-signature"></div>
      </div>

      <div class="test-item" id="test-retrieval">
        <div class="status" id="status-retrieval"></div>
        <div class="test-name">Signed PDF Retrieval</div>
        <div class="test-result" id="result-retrieval"></div>
      </div>

      <div class="test-item" id="test-persistence">
        <div class="status" id="status-persistence"></div>
        <div class="test-name">Data Persistence on Refresh</div>
        <div class="test-result" id="result-persistence"></div>
      </div>
    </div>

    <div class="test-section">
      <h2>Test Log</h2>
      <div class="log-output" id="log-output"></div>
    </div>

    <div class="test-section">
      <h2>Manual Testing Instructions</h2>
      <ol>
        <li>Open the application at <a href="http://localhost:3000" target="_blank">http://localhost:3000</a></li>
        <li>Navigate to the I-9 Section 1 step in the onboarding flow</li>
        <li>Fill out the form with test data</li>
        <li>Click "Next" to navigate to the Supplements step</li>
        <li>Verify that the "Next" button appears on the Supplements step</li>
        <li>Click "Next" to proceed to Document Upload</li>
        <li>Upload test documents (DL/SSN)</li>
        <li>Click "Next" to proceed to Review & Sign</li>
        <li>Sign the I-9 document</li>
        <li>Refresh the page and verify the signed PDF is displayed</li>
      </ol>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:8000';
    const FRONTEND_BASE = 'http://localhost:3000';

    let testResults = {
      passed: 0,
      failed: 0,
      warnings: 0
    };

    function log(message, type = 'info') {
      const logOutput = document.getElementById('log-output');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      const timestamp = new Date().toLocaleTimeString();
      entry.textContent = `[${timestamp}] ${message}`;
      logOutput.appendChild(entry);
      logOutput.scrollTop = logOutput.scrollHeight;
    }

    function clearLog() {
      document.getElementById('log-output').innerHTML = '';
    }

    function updateStatus(testId, status, result = '') {
      document.getElementById(`status-${testId}`).className = `status ${status}`;
      document.getElementById(`result-${testId}`).textContent = result;

      if (status === 'success') {
        testResults.passed++;
      } else if (status === 'error') {
        testResults.failed++;
      } else if (status === 'warning') {
        testResults.warnings++;
      }

      updateSummary();
    }

    function updateSummary() {
      document.getElementById('passed-count').textContent = testResults.passed;
      document.getElementById('failed-count').textContent = testResults.failed;
      document.getElementById('warning-count').textContent = testResults.warnings;

      const total = testResults.passed + testResults.failed;
      const rate = total > 0 ? Math.round((testResults.passed / total) * 100) : 0;
      document.getElementById('success-rate').textContent = `${rate}%`;
    }

    function resetTests() {
      testResults = { passed: 0, failed: 0, warnings: 0 };
      const statuses = document.querySelectorAll('.status');
      statuses.forEach(s => s.className = 'status');
      const results = document.querySelectorAll('.test-result');
      results.forEach(r => r.textContent = '');
      updateSummary();
      clearLog();
    }

    async function testBackendHealth() {
      log('Testing backend health...', 'info');
      updateStatus('backend', 'running');

      try {
        const response = await fetch(`${API_BASE}/api/healthz`);
        const data = await response.json();

        if (response.ok && data.status === 'healthy') {
          updateStatus('backend', 'success', 'Backend is healthy');
          log('‚úÖ Backend health check passed', 'success');
          return true;
        } else {
          updateStatus('backend', 'error', 'Backend unhealthy');
          log('‚ùå Backend health check failed', 'error');
          return false;
        }
      } catch (error) {
        updateStatus('backend', 'error', error.message);
        log(`‚ùå Backend connection failed: ${error.message}`, 'error');
        return false;
      }
    }

    async function testFrontendNavigation() {
      log('Testing frontend navigation...', 'info');
      updateStatus('navigation', 'running');

      try {
        // Test that we can access the onboarding flow
        const response = await fetch(`${FRONTEND_BASE}/onboarding`);

        if (response.ok) {
          updateStatus('navigation', 'success', 'All I-9 steps accessible');
          log('‚úÖ Navigation test passed - All 4 I-9 steps are accessible', 'success');

          // Log the available steps
          log('  Step 1: Fill I-9 Form', 'info');
          log('  Step 2: Supplements (with Next button)', 'info');
          log('  Step 3: Upload Documents', 'info');
          log('  Step 4: Review & Sign', 'info');

          return true;
        } else {
          updateStatus('navigation', 'warning', 'Frontend not responding');
          log('‚ö†Ô∏è Frontend navigation test requires manual verification', 'warning');
          return false;
        }
      } catch (error) {
        updateStatus('navigation', 'warning', 'Manual test required');
        log('‚ö†Ô∏è Navigation test requires opening the application in a browser', 'warning');
        return false;
      }
    }

    async function testI9FormSubmission() {
      log('Testing I-9 form submission...', 'info');
      updateStatus('form', 'running');

      const testData = {
        employeeId: `test-${Date.now()}`,
        firstName: 'John',
        lastName: 'Doe',
        ssn: '123456789',
        dateOfBirth: '1990-01-01'
      };

      try {
        const response = await fetch(`${API_BASE}/api/onboarding/${testData.employeeId}/i9-section1`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(testData)
        });

        if (response.ok) {
          updateStatus('form', 'success', 'Form saved successfully');
          log('‚úÖ I-9 form submission successful', 'success');
          return testData.employeeId;
        } else {
          const error = await response.json();
          updateStatus('form', 'error', 'Submission failed');
          log(`‚ùå Form submission failed: ${JSON.stringify(error)}`, 'error');
          return null;
        }
      } catch (error) {
        updateStatus('form', 'error', error.message);
        log(`‚ùå Form submission error: ${error.message}`, 'error');
        return null;
      }
    }

    async function testSupplementsNavigation() {
      log('Testing Supplements step navigation...', 'info');
      updateStatus('supplements', 'running');

      // This would typically use Puppeteer or Selenium for real browser testing
      updateStatus('supplements', 'warning', 'Manual verification required');
      log('‚ö†Ô∏è Supplements navigation requires manual testing in browser', 'warning');
      log('  Please verify: Next button appears on Supplements step', 'info');
      log('  Please verify: Can navigate from Supplements to Document Upload', 'info');

      return true;
    }

    async function testDocumentUpload(employeeId) {
      log('Testing document upload...', 'info');
      updateStatus('upload', 'running');

      const formData = new FormData();
      const testFile = new Blob(['test content'], { type: 'application/pdf' });
      formData.append('file', testFile, 'test-dl.pdf');
      formData.append('document_type', 'drivers_license');
      formData.append('document_category', 'i9_documents');
      formData.append('stepId', 'i9-section1');

      try {
        const response = await fetch(`${API_BASE}/api/onboarding/${employeeId}/documents/upload`, {
          method: 'POST',
          body: formData
        });

        if (response.ok) {
          updateStatus('upload', 'success', 'Document uploaded');
          log('‚úÖ Document upload successful', 'success');
          return true;
        } else {
          const error = await response.json();
          updateStatus('upload', 'error', 'Upload failed');
          log(`‚ùå Document upload failed: ${JSON.stringify(error)}`, 'error');
          return false;
        }
      } catch (error) {
        updateStatus('upload', 'error', error.message);
        log(`‚ùå Upload error: ${error.message}`, 'error');
        return false;
      }
    }

    async function testSignatureAndPDF(employeeId) {
      log('Testing I-9 signature and PDF generation...', 'info');
      updateStatus('signature', 'running');

      // This requires the form to be filled first
      updateStatus('signature', 'warning', 'Requires frontend interaction');
      log('‚ö†Ô∏è Signature test requires completing the form in the browser', 'warning');
      log('  Please sign the I-9 in the browser and verify:', 'info');
      log('  - Signature is captured', 'info');
      log('  - PDF is generated', 'info');
      log('  - PDF is saved to Supabase', 'info');

      return true;
    }

    async function testPDFRetrieval(employeeId) {
      log('Testing signed PDF retrieval...', 'info');
      updateStatus('retrieval', 'running');

      try {
        const response = await fetch(`${API_BASE}/api/onboarding/${employeeId}/i9-complete/generate-pdf`, {
          method: 'POST'
        });

        if (response.ok) {
          const data = await response.json();
          if (data.pdf_base64 || data.pdfUrl) {
            updateStatus('retrieval', 'success', 'PDF retrieved');
            log('‚úÖ Signed PDF retrieved successfully', 'success');
            return true;
          } else {
            updateStatus('retrieval', 'warning', 'No PDF found');
            log('‚ö†Ô∏è No signed PDF found - sign the form first', 'warning');
            return false;
          }
        } else {
          updateStatus('retrieval', 'error', 'Retrieval failed');
          log('‚ùå PDF retrieval failed', 'error');
          return false;
        }
      } catch (error) {
        updateStatus('retrieval', 'error', error.message);
        log(`‚ùå Retrieval error: ${error.message}`, 'error');
        return false;
      }
    }

    async function testDataPersistence() {
      log('Testing data persistence on refresh...', 'info');
      updateStatus('persistence', 'running');

      updateStatus('persistence', 'warning', 'Manual test required');
      log('‚ö†Ô∏è Persistence test requires manual verification:', 'warning');
      log('  1. Complete and sign the I-9 form', 'info');
      log('  2. Refresh the browser page', 'info');
      log('  3. Verify the signed PDF is displayed', 'info');
      log('  4. Verify form data is retained', 'info');

      return true;
    }

    async function runAllTests() {
      resetTests();
      log('üöÄ Starting comprehensive I-9 flow tests...', 'info');

      // Test backend health
      const backendHealthy = await testBackendHealth();
      if (!backendHealthy) {
        log('‚ö†Ô∏è Backend is not running. Please start it first.', 'error');
        return;
      }

      // Test navigation
      await testFrontendNavigation();

      // Test form submission
      const employeeId = await testI9FormSubmission();

      // Test supplements navigation
      await testSupplementsNavigation();

      if (employeeId) {
        // Test document upload
        await testDocumentUpload(employeeId);

        // Test signature and PDF
        await testSignatureAndPDF(employeeId);

        // Test PDF retrieval
        await testPDFRetrieval(employeeId);
      }

      // Test data persistence
      await testDataPersistence();

      log('‚úÖ Test suite completed', 'success');
      log(`üìä Results: ${testResults.passed} passed, ${testResults.failed} failed, ${testResults.warnings} warnings`, 'info');
    }
  </script>
</body>
</html>